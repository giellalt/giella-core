#!/bin/bash
# @configure_input@

# Test that running pipeline from archive has same results as gold standard

if ! test $# -ge 4 ; then
    echo
    echo "Usage: $0 ARCHIVE TESTFILE GOLD [VARIANT]"
    echo
    echo "were:"
    echo " ARCHIVE is the bundle.drb file"
    echo " TESTFILE is input text"
    echo " GOLD is expected output"
    echo " VARIANT is the variant in archive to run"
    echo
    echo "LEVEL defaults to maintags if not given"
    echo "THRESHOLD defaults to 99 % if not given"
    exit 77
fi

runner="@DIVVUN_RUNTIME@"
archive=$1
testfile=$2
goldfile=$3
if test $# -ge 4 ; then
    level=$4
fi


. "@GIELLA_CORE@/scripts/termcolors.bash"

if ! test -f $runner ; then
    printf "%sskip%s missing pipeline runner from divvun-runtime" \
        "$light_blue" "$reset" 
    exit 77
fi
if ! test -f $archive ; then
    printf "%sskip%s missing pipeline archive %s\n" "$light_blue" "$reset" \
        "$archive"
    exit 77
fi
if ! test -f $testfile ; then
    printf "%sskip%s missing test data %s\n" "$light_blue" "$reset" \
        "$testfile"
    exit 77
fi
if ! test -f $goldfile ; then
    printf "%sskip%s missing gold data %s\n" "$light_blue" "$reset" \
        "$goldfile"
    echo "hint: $runner -a $archive -n $variant < $testfile > $goldfile"
    exit 77
fi
DIFF="diff -u"
if test -x @WDIFF@ ; then
    DIFF=@WDIFF@
fi
outfile=$(mktemp -t giella-pipeline-test.XXXXXXXXXXX)

$runner run -p "$archive" < "$testfile" > "$outfile"
rv=$?
if test $rv -gt 0 ; then
    printf "%sfail%s running $runner failed (see above?)\n" "$red" "$reset"
   exit $rv
fi
if cmp "$goldfile" "$outfile" > /dev/null ; then
    printf "%spass%s - exact match\n" "$green" "$reset"
else
    printf "%sfail%s - outputs differ from expectations:\n" "$red" "$reset"
    $DIFF "$outfile" "$goldfile"
    exit 1
fi
